name: Release production apps for Nebula
# 'all/v0.0.2' => 'all/v0.0.2'
"on":
  pull_request:
  push:
    tags:
      - trading/v*
      - console/v*
      - explorer/v*
      - governance/*
      - all/v*


jobs:
  build_dist:
    name: "Build dist"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Setup node
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: yarn

      - name: Cache node modules
        id: cache
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-cache-node-modules-${{ hashFiles('yarn.lock') }}

      - name: Build explorer
        shell: bash
        if: ${{ contains('all/v0.0.2', 'explorer') || contains('all/v0.0.2', 'all') }}
        run: |
          yarn env-cmd -f ./apps/explorer/.env.nebula1 yarn nx build explorer


      - name: Build console
        shell: bash
        if: ${{ contains('all/v0.0.2', 'trading') || contains('all/v0.0.2', 'console') || contains('all/v0.0.2', 'all') }}
        run: |
          yarn env-cmd -f ./apps/trading/.env.nebula1 yarn nx build trading
          yarn nx export

      - name: Build governance
        shell: bash
        if: ${{ contains('all/v0.0.2', 'explorer') || contains('all/v0.0.2', 'all') }}
        run: |
          yarn env-cmd -f ./apps/governance/.env.nebula1 yarn nx build governance

      - name: Upload built artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend_dist
          path: ./dist/

  publish_dist:
    name: "Publis dist"
    needs: build_dist
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target: ${{ fromJSON( vars.JSON_FRONTEND_SERVERS) }}
    steps:
      - name: "Publish explorer"
        if: ${{ contains('all/v0.0.2', 'explorer') || contains('all/v0.0.2', 'all') }}
        run: |
          echo "Publishing explorer for ${{ matrix.target }}"

      - name: "Publish console"
        run: |
          echo "Publishing console for ${{ matrix.target }}"
        if: ${{ contains('all/v0.0.2', 'trading') || contains('all/v0.0.2', 'console') || contains('all/v0.0.2', 'all') }}

      - name: "Publish governance"
        run: |
          echo "Publishing governance for ${{ matrix.target }}"
        if: ${{ contains('all/v0.0.2', 'explorer') || contains('all/v0.0.2', 'all') }}